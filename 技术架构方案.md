# 技术架构设计方案

## 1. 系统架构概览

```
   React Native 应用
  (单一代码库，跨平台)
    ┌─────────────────┐
    │   iOS 平台      │   Android 平台   │
    └─────────────────┘
              |
         WebSocket/HTTP
              |
         Node.js 服务器
              |
      +-------+-------+
      |               |
   Socket.io      WebRTC
     服务          信令服务
      |               |
   消息存储        P2P音视频通信
```

## 2. 前端架构 (React Native)

### 2.1 项目结构
```
react-native-video-chat/
├── src/
│   ├── components/          # 通用组件
│   │   ├── VideoView.js    # 视频显示组件
│   │   ├── ChatInput.js    # 聊天输入组件
│   │   └── MessageList.js  # 消息列表组件
│   ├── screens/            # 页面
│   │   └── MainScreen.js   # 主页面
│   ├── services/           # 服务层
│   │   ├── webrtcService.js # WebRTC管理封装
│   │   └── socketService.js # Socket通信
│   ├── utils/              # 工具函数
│   └── App.js             # 应用入口
├── package.json
└── metro.config.js
```

### 2.2 核心依赖
```json
{
  "react-native": "^0.72.0",
  "react-native-webrtc": "^118.0.0", 
  "socket.io-client": "^4.7.0",
  "@react-native-async-storage/async-storage": "^1.19.0"
}
```

### 2.3 状态管理
- 使用React Hooks (useState, useEffect)
- 本地状态管理，避免引入Redux增加复杂度
- AsyncStorage存储token和基础设置

### 2.4 跨平台优势
- **单一代码库**: 95%+代码在iOS和Android间共享
- **统一开发流程**: 同一套开发、测试、调试环境
- **一致性保证**: UI/UX在两个平台保持高度一致
- **维护简化**: 只需维护一套代码逻辑

## 3. 后端架构 (Node.js)

### 3.1 项目结构  
```
nodejs-server/
├── src/
│   ├── controllers/        # 控制器
│   │   ├── roomController.js   # 房间管理
│   │   └── signalingController.js # 信令管理
│   ├── services/           # 服务层
│   │   ├── webrtcSignaling.js # WebRTC信令服务
│   │   └── socketService.js     # Socket事件处理
│   ├── models/             # 数据模型
│   │   └── Room.js        # 房间模型
│   ├── routes/             # 路由
│   │   └── api.js         # API路由
│   └── app.js             # 应用入口
├── package.json
└── .env
```

### 3.2 核心依赖
```json
{
  "express": "^4.18.0",
  "socket.io": "^4.7.0", 
  "cors": "^2.8.0",
  "dotenv": "^16.0.0",
  "uuid": "^9.0.0"
}
```

### 3.3 数据存储
- 内存存储房间状态（极简设计）
- 不使用数据库，避免增加复杂度
- 房间数据结构：
```javascript
{
  roomId: string,      // 房间ID（基于token生成）
  users: Array,        // 用户列表
  messages: Array,     // 消息历史（最近50条）
  createdAt: Date      // 创建时间
}
```

## 4. 通信架构

### 4.1 音视频通信
```
客户端A ←→ WebRTC P2P直连 ←→ 客户端B
```
- 使用WebRTC直接进行P2P通信
- 服务器仅负责信令交换和房间管理

### 4.2 文字消息通信
```
客户端A → Socket.io服务器 → 客户端B
```
- WebSocket实时双向通信
- 服务器转发消息

### 4.3 API接口设计
```
POST /api/join-room
- 参数: { token: string }
- 返回: { roomId: string, success: boolean }

WebSocket事件:
- join-room: 加入房间
- send-message: 发送消息  
- receive-message: 接收消息
- webrtc-offer: 发送WebRTC Offer
- webrtc-answer: 发送WebRTC Answer  
- webrtc-ice-candidate: 发送ICE候选者
- user-joined: 用户加入
- user-left: 用户离开
```

## 5. WebRTC集成方案

### 5.1 信令服务器
- 后端提供WebRTC信令交换服务
- 基于Socket.io实现Offer/Answer交换
- ICE候选者信息交换

### 5.2 音视频配置
```javascript
const webrtcConfig = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
  ],
  video: {
    width: { min: 640, ideal: 1280, max: 1920 },
    height: { min: 360, ideal: 720, max: 1080 },
    frameRate: { min: 15, ideal: 30, max: 30 }
  },
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true
  }
}
```

## 6. 部署架构

### 6.1 后端部署
- 云服务器（阿里云/腾讯云）
- PM2进程管理
- Nginx反向代理
- HTTPS支持

### 6.2 前端发布
- Android: 生成APK文件
- iOS: 提交App Store或TestFlight

### 6.3 环境配置
```
开发环境: 本地Node.js + React Native开发
测试环境: 云服务器测试部署
生产环境: 云服务器正式部署 + CDN加速
```

## 7. 安全设计

### 7.1 Token机制
- 客户端Token用于房间匹配
- 简化验证机制，无需复杂的Token管理
- 房间会话有效期限制

### 7.2 数据传输
- HTTPS/WSS加密传输
- WebRTC内置DTLS/SRTP端对端加密

## 8. 性能优化

### 8.1 前端优化
- 组件按需渲染
- 消息列表虚拟滚动（如消息量大）
- 图片/视频资源压缩

### 8.2 后端优化
- Socket连接池管理
- 内存使用监控
- 房间自动清理机制

## 9. 开发工具链

### 9.1 开发环境
- Node.js 18+
- React Native CLI
- Android Studio / Xcode
- VS Code + React Native插件

### 9.2 调试工具
- React Native Debugger
- Flipper
- WebRTC内部统计 (chrome://webrtc-internals)

## 10. 扩展考虑

### 10.1 未来可扩展功能
- 屏幕共享
- 录音录像
- 群组聊天
- 用户系统

### 10.2 技术升级路径
- 引入Redis缓存
- 数据库持久化存储
- 微服务架构拆分